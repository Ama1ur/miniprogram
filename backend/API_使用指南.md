# å­¦ç”Ÿè€ƒè¯•åˆ†æå°ç¨‹åº - APIä½¿ç”¨æŒ‡å—

## ğŸ‰ å®ç°å®Œæˆæƒ…å†µ

**æ‰€æœ‰å­¦ç”Ÿç«¯æ ¸å¿ƒåˆ†æAPIå·²å…¨éƒ¨å®ç°ï¼** âœ…

## ğŸ“‹ å·²å®ç°çš„APIæ¥å£

### 1. ç”¨æˆ·è®¤è¯
- `POST /auth/login` - ç”¨æˆ·ç™»å½•ä¸èº«ä»½ç»‘å®š

### 2. å­¦ç”Ÿç«¯æ ¸å¿ƒåˆ†ææ¥å£ (å…±10ä¸ª)

| åºå· | æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½æè¿° | å¯¹åº”é¡µé¢ |
|------|----------|------|----------|----------|
| 1 | `/student/exams` | GET | è·å–å†å²è€ƒè¯•åˆ—è¡¨ | è€ƒè¯•é€‰æ‹©é¡µ |
| 2 | `/student/exams/{examId}/scores` | GET | è·å–è€ƒè¯•æˆç»©é¡µæ•°æ® | 01-è€ƒè¯•æˆç»©é¡µ |
| 3 | `/student/exams/{examId}/level-position` | GET | è·å–ç­‰çº§ä½ç½®é¡µæ•°æ® | 02-ç­‰çº§ä½ç½®é¡µ |
| 4 | `/student/exams/{examId}/pk-analysis` | GET | è·å–æˆç»©PKé¡µæ•°æ® | 03-æˆç»©PKé¡µ |
| 5 | `/student/exams/{examId}/ideal-ranking` | POST | è®¡ç®—ç†æƒ³æ’åé¡µæ•°æ® | 04-ç†æƒ³æ’åé¡µ |
| 6 | `/student/exams/{examId}/bias-analysis` | GET | è·å–åç§‘åˆ†æé¡µæ•°æ® | 05-åç§‘åˆ†æé¡µ |
| 7 | `/student/trend-analysis` | GET | è·å–å†æ¬¡è¶‹åŠ¿é¡µæ•°æ® | 06-å†æ¬¡è¶‹åŠ¿é¡µ |
| 8 | `/student/exams/{examId}/question-analysis` | GET | è·å–è¯•é¢˜åˆ†æé¡µæ•°æ® | 07-è¯•é¢˜åˆ†æé¡µ |
| 9 | `/student/exams/{examId}/loss-analysis` | GET | è·å–å¤±åˆ†åˆ†æé¡µæ•°æ® | 08-å¤±åˆ†åˆ†æé¡µ |
| 10 | `/student/exams/{examId}/knowledge-analysis` | GET | è·å–çŸ¥è¯†ç‚¹åˆ†æé¡µæ•°æ® | 09-çŸ¥è¯†ç‚¹åˆ†æé¡µ |

### 3. æ•™å¸ˆç«¯æ¥å£ (å…±2ä¸ª)

| åºå· | æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½æè¿° | å¯¹åº”é¡µé¢ |
|------|----------|------|----------|----------|
| 1 | `/teacher/classes` | GET | è·å–æ•™å¸ˆæ‰€æ•™ç­çº§åˆ—è¡¨ | ç­çº§é€‰æ‹©é¡µ |
| 2 | `/teacher/classes/{classId}/scores` | GET | è·å–ç­çº§æˆç»©å• | ç­çº§æˆç»©é¡µ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨APIæœåŠ¡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æœåŠ¡
python start.py
```

### 2. è®¿é—®APIæ–‡æ¡£

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### 3. è¿è¡Œå®Œæ•´æµ‹è¯•

```bash
# å®Œæ•´ç³»ç»Ÿæµ‹è¯• (æ¨è)
python test_complete_apis.py

# åˆ†åˆ«æµ‹è¯•å­¦ç”Ÿç«¯API
python test_all_apis.py

# åˆ†åˆ«æµ‹è¯•æ•™å¸ˆç«¯API
python test_teacher_apis.py

# åŸºç¡€åŠŸèƒ½æµ‹è¯•
python test_api.py
```

## ğŸ” è®¤è¯æµç¨‹

### 1. è·å–Token

```bash
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "mock_code_123",
    "userType": "student",
    "identityId": "20240001",
    "password": "123456"
  }'
```

**å“åº”**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userInfo": {
    "id": "1",
    "name": "æµ‹è¯•å­¦ç”Ÿ",
    "type": "student",
    "avatar": null
  }
}
```

### 2. ä½¿ç”¨Tokenè®¿é—®æ¥å£

åœ¨åç»­è¯·æ±‚ä¸­åŠ å…¥Header:
```
Authorization: Bearer {your_token_here}
```

## ğŸ“Š æ¥å£è¯¦ç»†è¯´æ˜

### 01. è€ƒè¯•æˆç»©é¡µ (`/student/exams/{examId}/scores`)

**åŠŸèƒ½**: è·å–æŒ‡å®šè€ƒè¯•çš„æ€»åˆ†ã€ç­‰çº§åŠå„ç§‘æˆç»©
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "total_score": 532.0,
  "overall_level": "A3",
  "subject_scores": [
    {"subject": "è¯­æ–‡", "score": 85.5, "level": "B1"},
    {"subject": "æ•°å­¦", "score": 92.0, "level": "A2"},
    {"subject": "è‹±è¯­", "score": 78.5, "level": "B2"}
  ]
}
```

### 02. ç­‰çº§ä½ç½®é¡µ (`/student/exams/{examId}/level-position`)

**åŠŸèƒ½**: å±•ç¤ºæˆç»©å¯¹æ¯”è¡¨æ ¼ï¼ˆæŒ‰ç­çº§/å¹´çº§åˆ‡æ¢ï¼‰
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID
- `mode`: å¯¹æ¯”æ¨¡å¼ (`class` æˆ– `grade`)

**å“åº”ç¤ºä¾‹**:
```json
{
  "grouping_mode": "ç­çº§",
  "class_size": 45,
  "grade_size": 180,
  "subject_comparison": [
    {
      "subject": "è¯­æ–‡",
      "score": 85.5,
      "rank": 15,
      "avg": 78.2,
      "max": 98.5,
      "diff": 13.0
    }
  ]
}
```

### 03. æˆç»©PKé¡µ (`/student/exams/{examId}/pk-analysis`)

**åŠŸèƒ½**: å±•ç¤ºç­çº§å†…å‡»è´¥ç‡å’Œæ’å
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID
- `class_id`: ç­çº§ID (å¯é€‰)

**å“åº”ç¤ºä¾‹**:
```json
{
  "rank_percent": 75.6,
  "rank_index": 11,
  "class_total_students": 45
}
```

### 04. ç†æƒ³æ’åé¡µ (`/student/exams/{examId}/ideal-ranking`)

**åŠŸèƒ½**: æ ¹æ®ç†æƒ³åˆ†æ•°è®¡ç®—æ–°çš„æ€»åˆ†å’Œé¢„æµ‹æ’å
**æ–¹æ³•**: POST
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID

**è¯·æ±‚ä½“**:
```json
{
  "ideal_scores": [
    {"subject": "æ•°å­¦", "ideal_score": 140.0},
    {"subject": "è‹±è¯­", "ideal_score": 120.0}
  ]
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "subjects": [
    {
      "subject": "æ•°å­¦",
      "current_score": 92.0,
      "ideal_score": 140.0,
      "max_score": 150
    }
  ],
  "new_total_score": 580.0,
  "predicted_rank": 5,
  "rank_change": 10,
  "current_rank": 15
}
```

### 05. åç§‘åˆ†æé¡µ (`/student/exams/{examId}/bias-analysis`)

**åŠŸèƒ½**: é›·è¾¾å›¾æ•°æ®åŠä¼˜åŠ¿ã€åŠ£åŠ¿å­¦ç§‘è¯Šæ–­
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "radar_data": [
    {
      "subject": "æ•°å­¦",
      "total_win_rate": 75.6,
      "subject_win_rate": 85.3
    }
  ],
  "strength_subjects": ["æ•°å­¦", "åŒ–å­¦"],
  "weak_subjects": ["è‹±è¯­", "è¯­æ–‡"]
}
```

### 06. å†æ¬¡è¶‹åŠ¿é¡µ (`/student/trend-analysis`)

**åŠŸèƒ½**: å†æ¬¡è€ƒè¯•å‡»è´¥ç‡å˜åŒ–æŠ˜çº¿å›¾
**å‚æ•°**: 
- `mode`: å¯¹æ¯”æ¨¡å¼ (`class` æˆ– `school`)

**å“åº”ç¤ºä¾‹**:
```json
{
  "trend_data": [
    {
      "date": "2024å¹´1æœˆæœŸæœ«",
      "class_win_rate": 75.6,
      "school_win_rate": 67.2
    }
  ],
  "trend_analysis": "æœ¬æ¬¡è€ƒè¯•ç›¸æ¯”ä¸Šæ¬¡æå‡äº†2.4ä¸ªç™¾åˆ†ç‚¹..."
}
```

### 07. è¯•é¢˜åˆ†æé¡µ (`/student/exams/{examId}/question-analysis`)

**åŠŸèƒ½**: æŒ‰ç§‘ç›®æŸ¥çœ‹é¢˜ç›®å¾—åˆ†æƒ…å†µ
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID
- `subject`: ç§‘ç›®åç§°

**å“åº”ç¤ºä¾‹**:
```json
{
  "selected_subject": "æ•°å­¦",
  "available_subjects": ["æ€»åˆ†", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­"],
  "current_questions": [
    {
      "id": 1,
      "type": "å•é€‰é¢˜",
      "correct_answer": "A",
      "full_score": 5.0,
      "score": 5.0,
      "analysis_url": null
    }
  ]
}
```

### 08. å¤±åˆ†åˆ†æé¡µ (`/student/exams/{examId}/loss-analysis`)

**åŠŸèƒ½**: æŒ‰éš¾åº¦åˆ†ç»„çš„ä½œç­”æƒ…å†µåŠå¤±åˆ†åˆ†æ
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "difficulty_analysis": [
    {
      "level": "ææ˜“",
      "total_score": 25.0,
      "count": 5,
      "correct": 4,
      "partial": 1,
      "rate": 90.0,
      "question_numbers": ["1", "2", "5"]
    }
  ],
  "loss_questions": {
    "å…¨éƒ¨ä¸¢åˆ†": ["å•é€‰3", "å¤šé€‰11"],
    "éƒ¨åˆ†ä¸¢åˆ†": ["è§£ç­”22", "è§£ç­”23"]
  },
  "ä¼˜åŠ¿å¾—åˆ†é¢˜": ["å•é€‰1", "å•é€‰2"],
  "æ½œåŠ›è¿½åˆ†é¢˜": ["å•é€‰4", "å¤šé€‰7"],
  "gain_prediction": {
    "potential_gain_score": 16.5,
    "rank_improvement": 8
  }
}
```

### 09. çŸ¥è¯†ç‚¹åˆ†æé¡µ (`/student/exams/{examId}/knowledge-analysis`)

**åŠŸèƒ½**: å„çŸ¥è¯†ç‚¹å¾—åˆ†ç‡å¯¹æ¯”å’ŒæŒæ¡ç¨‹åº¦
**å‚æ•°**: 
- `examId`: è€ƒè¯•ID

**å“åº”ç¤ºä¾‹**:
```json
{
  "knowledge_points": [
    {
      "name": "å‡½æ•°ä¸å¯¼æ•°",
      "class_rate": 78.5,
      "personal_rate": 85.2,
      "level": "ä¼˜ç§€æŒæ¡"
    }
  ],
  "tabs": ["æ»¡åˆ†çŸ¥è¯†ç‚¹", "ä¼˜åŠ¿çŸ¥è¯†ç‚¹", "çŸ­æ¿çŸ¥è¯†ç‚¹"]
}
```

## ğŸ æ•™å¸ˆç«¯æ¥å£è¯¦ç»†è¯´æ˜

### 01. è·å–ç­çº§åˆ—è¡¨ (`/teacher/classes`)

**åŠŸèƒ½**: è·å–å½“å‰æ•™å¸ˆæ‰€æ•™çš„æ‰€æœ‰ç­çº§åˆ—è¡¨
**æ–¹æ³•**: GET
**è®¤è¯**: éœ€è¦æ•™å¸ˆèº«ä»½Token

**å“åº”ç¤ºä¾‹**:
```json
[
  {"class_id": "class_001", "class_name": "é«˜ä¸‰(1)ç­"},
  {"class_id": "class_002", "class_name": "é«˜ä¸‰(2)ç­"},
  {"class_id": "class_003", "class_name": "é«˜ä¸‰(3)ç­"},
  {"class_id": "class_004", "class_name": "é«˜ä¸‰(4)ç­"}
]
```

### 02. è·å–ç­çº§æˆç»©å• (`/teacher/classes/{classId}/scores`)

**åŠŸèƒ½**: è·å–æŒ‡å®šç­çº§çš„æˆç»©ç»Ÿè®¡å’Œå­¦ç”Ÿæ’å
**æ–¹æ³•**: GET
**è®¤è¯**: éœ€è¦æ•™å¸ˆèº«ä»½Token
**å‚æ•°**: 
- `classId`: ç­çº§ID (è·¯å¾„å‚æ•°)
- `examId`: è€ƒè¯•ID (æŸ¥è¯¢å‚æ•°)

**å“åº”ç¤ºä¾‹**:
```json
{
  "statistics": {
    "avgScore": 485.2,
    "maxScore": 612.5,
    "passRate": 87.5
  },
  "students": [
    {
      "student_id": "stu_001",
      "student_name": "å¼ ä¸‰",
      "total_score": 612.5,
      "rank": 1
    },
    {
      "student_id": "stu_002", 
      "student_name": "æå››",
      "total_score": 598.0,
      "rank": 2
    }
  ]
}
```

**æƒé™æ§åˆ¶**: 
- æ•™å¸ˆåªèƒ½æŸ¥çœ‹è‡ªå·±æ‰€æ•™ç­çº§çš„æˆç»©
- è®¿é—®æ— æƒé™ç­çº§å°†è¿”å›403é”™è¯¯

## ğŸ› ï¸ æŠ€æœ¯ç‰¹æ€§

### ğŸ”’ å®‰å…¨è®¤è¯
- **JWT Token**: åŸºäºJWTçš„æ— çŠ¶æ€è®¤è¯
- **æƒé™æ§åˆ¶**: å­¦ç”Ÿ/æ•™å¸ˆè§’è‰²åˆ†ç¦»
- **å¾®ä¿¡é›†æˆ**: æ”¯æŒå¾®ä¿¡å°ç¨‹åºç™»å½•

### ğŸ“ APIè§„èŒƒ
- **OpenAPI 3.0**: å®Œæ•´çš„APIæ–‡æ¡£è§„èŒƒ
- **ç±»å‹å®‰å…¨**: Pydanticæ¨¡å‹éªŒè¯
- **è‡ªåŠ¨æ–‡æ¡£**: Swagger UI + ReDoc

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: FastAPIå¼‚æ­¥æ”¯æŒ
- **æ•°æ®åˆ†é¡µ**: æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- **ç¼“å­˜å‹å¥½**: RESTfulè®¾è®¡

### ğŸ§ª æµ‹è¯•è¦†ç›–
- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæ¥å£ç‹¬ç«‹æµ‹è¯•
- **é›†æˆæµ‹è¯•**: å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
- **æ¨¡æ‹Ÿæ•°æ®**: çœŸå®åœºæ™¯æ¨¡æ‹Ÿ

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
miniprogram-2/
â”œâ”€â”€ main.py                    # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ config.py                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ database.py                # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ auth.py                    # JWTè®¤è¯æ¨¡å—
â”œâ”€â”€ models.py                  # æ•°æ®åº“æ¨¡å‹
â”œâ”€â”€ requirements.txt           # ä¾èµ–åŒ…
â”œâ”€â”€ routers/                   # APIè·¯ç”±
â”‚   â”œâ”€â”€ auth.py               # è®¤è¯æ¥å£
â”‚   â”œâ”€â”€ student.py            # å­¦ç”Ÿç«¯æ¥å£
â”‚   â””â”€â”€ teacher.py            # æ•™å¸ˆç«¯æ¥å£
â”œâ”€â”€ start.py                   # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_complete_apis.py     # å®Œæ•´ç³»ç»Ÿæµ‹è¯• (æ¨è)
â”œâ”€â”€ test_all_apis.py          # å­¦ç”Ÿç«¯APIæµ‹è¯•
â”œâ”€â”€ test_teacher_apis.py      # æ•™å¸ˆç«¯APIæµ‹è¯•
â”œâ”€â”€ test_api.py               # åŸºç¡€APIæµ‹è¯•
â”œâ”€â”€ backend_README.md         # åç«¯æ–‡æ¡£
â”œâ”€â”€ API_ä½¿ç”¨æŒ‡å—.md           # æœ¬æ–‡æ¡£
â””â”€â”€ openapi.yaml              # APIè§„èŒƒæ–‡æ¡£
```

## ğŸ¯ åç»­å¼€å‘å»ºè®®

### 1. æ•°æ®åº“é›†æˆ
- æ›¿æ¢æ¨¡æ‹Ÿæ•°æ®ä¸ºçœŸå®æ•°æ®åº“æŸ¥è¯¢
- ä¼˜åŒ–SQLæŸ¥è¯¢æ€§èƒ½
- æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶

### 2. åŠŸèƒ½æ‰©å±•
- æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½ (Excel/PDF)
- æ”¯æŒå¤šç§å›¾è¡¨æ ¼å¼
- å®ç°æˆç»©å¯¹æ¯”åŠŸèƒ½
- æ·»åŠ æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ

### 3. æ€§èƒ½ä¼˜åŒ–
- æ·»åŠ Redisç¼“å­˜
- å®ç°APIé™æµ
- ä¼˜åŒ–æ•°æ®ä¼ è¾“

### 4. ç›‘æ§è¿ç»´
- æ·»åŠ æ—¥å¿—è®°å½•
- å®ç°å¥åº·æ£€æŸ¥
- éƒ¨ç½²DockeråŒ–

## ğŸ’¡ ä½¿ç”¨æç¤º

1. **å¼€å‘æ¨¡å¼**: ä½¿ç”¨ `python start.py` å¯åŠ¨ï¼Œæ”¯æŒçƒ­é‡è½½
2. **ç”Ÿäº§æ¨¡å¼**: ä½¿ç”¨ `uvicorn main:app --host 0.0.0.0 --port 8000`
3. **APIæµ‹è¯•**: ä¼˜å…ˆä½¿ç”¨ Swagger UI è¿›è¡Œäº¤äº’å¼æµ‹è¯•
4. **æ•°æ®æ ¼å¼**: æ‰€æœ‰æ—¥æœŸä½¿ç”¨ ISO 8601 æ ¼å¼
5. **é”™è¯¯å¤„ç†**: éµå¾ªHTTPçŠ¶æ€ç æ ‡å‡†

## â“ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è·å–å­¦ç”ŸIDï¼Ÿ**
A: é€šè¿‡ `/auth/login` ç™»å½•åï¼Œä»JWT tokenä¸­è§£æè·å–

**Q: æ”¯æŒå“ªäº›ç§‘ç›®ï¼Ÿ**
A: è¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€æ–‡ç§‘ç»¼åˆ

**Q: å¦‚ä½•åˆ‡æ¢ä¸åŒè€ƒè¯•ï¼Ÿ**
A: å…ˆè°ƒç”¨ `/student/exams` è·å–è€ƒè¯•åˆ—è¡¨ï¼Œå†ä½¿ç”¨å¯¹åº”çš„ `examId`

**Q: ç†æƒ³æ’åå¦‚ä½•è®¡ç®—ï¼Ÿ**
A: åŸºäºæäº¤çš„ç†æƒ³åˆ†æ•°ï¼Œä½¿ç”¨ç®€å•ç®—æ³•é¢„æµ‹æ’åå˜åŒ–

---

**ğŸ‰ æ­å–œï¼æ‰€æœ‰å­¦ç”Ÿç«¯æ ¸å¿ƒåˆ†æAPIå’Œæ•™å¸ˆç«¯APIå·²å®Œç¾å®ç°ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå¾®ä¿¡å°ç¨‹åºå‰ç«¯å¼€å‘ï¼**

### ğŸ“ˆ åŠŸèƒ½å®Œæˆæƒ…å†µ

- âœ… **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**: å®Œæ•´çš„JWTè®¤è¯ï¼Œæ”¯æŒå­¦ç”Ÿ/æ•™å¸ˆè§’è‰²åŒºåˆ†
- âœ… **å­¦ç”Ÿç«¯API**: 10ä¸ªæ ¸å¿ƒåˆ†ææ¥å£å…¨éƒ¨å®ç°
- âœ… **æ•™å¸ˆç«¯API**: 2ä¸ªç®¡ç†æ¥å£å…¨éƒ¨å®ç°  
- âœ… **æƒé™æ§åˆ¶**: å®Œå–„çš„è§’è‰²æƒé™éªŒè¯
- âœ… **APIæ–‡æ¡£**: è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼æ–‡æ¡£
- âœ… **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬

**æ€»è®¡å®ç°æ¥å£æ•°: 13ä¸ª** ğŸš€ 